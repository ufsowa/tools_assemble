#!/bin/bash

edytuj()
{
#    myfile="u"$1"u"$2
    #utworz katalog symulacji
#    mkdir $myfile
    #skopij zawartosc katalogu tamplate do kat. symulacji
#    cp ../template/* ./$myfile
    #wejdz do katalogu symulacji
#    cd $myfile
    #edytuj plik chem.in
    sed -e 's/potencialy/'$chem1' '$chem2'/' chem.in > temp.in
    cat temp.in > chem.in
    rm temp.in
    #edytuj plik conf.in
    sed -e 's/TEMPERATURA/'$1'/' conf.in > temp.in
    cat temp.in > conf.in
    rm temp.in
    sed -e 's/STECH/'$2'/' conf.in > temp.in
    cat temp.in > conf.in
    rm temp.in

    #edytuj plik uruchomieniowy
    sed 's/#PBS -N name/#PBS -N s'$2'/' run_sim > tmp
    cat tmp > run_sim
    
    rm tmp
    #wroc do katalogu uruchomieniowego
    cd ..

}


echo "Tworze strukture katalogow..."



export LC_NUMERIC=C


stpth=$PWD
templ=$PWD/template/*
Temp=1400.0
#stech=1.0
N=500

for i in ./S$1; do
    name=${i#./}
    mkdir $stpth/data/$name
    cd $i
    iter=0
    for j in ./*.xyz ; do
	if [ $iter -lt $N ] ; then
	rm -r $stpth/data/$name/sample${iter}
	mkdir $stpth/data/$name/sample${iter}
	cp $j $stpth/data/$name/sample${iter}/start.in
	cp ${templ} $stpth/data/$name/sample${iter}/
	sed -i 's/SAMPLE/s'$iter'/' $stpth/data/$name/sample${iter}/run_sim
	fi
	((iter++))
    done	#skonczylem wszystkie stech.xyz
    #musze dorobic do N?
    if [ $iter -lt $N ]; then
    nr_stech=$iter
    repeat=`awk -v n=$N -v d=$iter 'BEGIN{printf "%1.0d", n/d }'`
    
    for (( k=0; k<$repeat; k++ )); do
	for j in ./*.xyz ; do
	    if [ $iter -lt $N ] ; then
		rm -r $stpth/data/$name/sample${iter}
		mkdir $stpth/data/$name/sample${iter}
		cp $j $stpth/data/$name/sample${iter}/start.in
		cp ${templ} $stpth/data/$name/sample${iter}/
		sed -i 's/SAMPLE/s'$iter'/' $stpth/data/$name/sample${iter}/run_sim
	    fi
	    ((iter++))
	done	#skonczylem wszystkie stech.xyz
    done
    fi
    cd $stpth/data/$name
    echo "iter/ repeat: ("$repeat"+1)*"$nr_stech"="$iter
    nr_dir=`ls -l | grep -v ^l | wc -l`
    echo "nr dir/ nr stech: ("$nr_dir"-1)="$N
    cd $stpth
done

